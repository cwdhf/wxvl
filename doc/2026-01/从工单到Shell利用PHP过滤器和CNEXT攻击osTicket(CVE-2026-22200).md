#  从工单到Shell:利用PHP过滤器和CNEXT攻击osTicket(CVE-2026-22200)  
horizon3
                    horizon3  赛博知识驿站   2026-01-24 08:01  
  
   
## 要点速览  
  
Horizon3.ai 在开源工单系统 osTicket  
 中发现了一个 CTF 风格的漏洞 CVE-2026-22200  
,允许匿名攻击者通过 PHP 过滤链读取服务器任意文件,并可结合 CVE-2024-2961  
(CNEXT)实现远程代码执行。  
### 漏洞核心机制  
1. 1. **利用 mPDF 库缺陷**  
:osTicket 使用旧版 mPDF  
 生成 PDF,存在 URL 编码绕过黑名单的问题。通过 php%3a//  
 可绕过流包装器检查,因为库在检查后才进行 URL 解码。  
  
1. 2. **绕过 HTML 净化**  
:利用 htmLawed  
 库的解析差异,通过不完整的 HTML 实体 &#34  
(无分号)绕过检查。Payload 流程为:  
  
1. • 输入:url&#34(php%3a//myurl)  
  
1. • 经过实体解码和字符剥离后变为:url(php://myurl)  
  
1. • 最终在 mPDF 中解码为:url(php://myurl)  
  
1. 3. **文件外泄技巧**  
:使用 PHP 过滤链在文件头部添加合法的 BMP 图像头,欺骗 mPDF 将任意文件(如 /etc/passwd  
)渲染为图像嵌入 PDF,然后从 PDF 中提取原始数据。  
  
### 攻击路径  
  
**获取工单访问权限**  
:  
- • 默认配置允许自注册账户  
  
- • 或通过暴力破解 6 位工单号(10 万-99.9 万范围),可绕过速率限制,1 小时内完成  
  
**注入 Payload**  
:在工单富文本内容中注入恶意 list-style-image  
 CSS 属性  
  
**导出 PDF**  
:打印工单触发 mPDF 处理,敏感文件以 BMP 图像形式嵌入 PDF  
### 高危影响  
- • **配置文件泄露**  
:可读取 include/ost-config.php  
 获取数据库凭据和 SECRET_SALT  
 密钥  
  
- • **伪造访问链接**  
:利用 SECRET_SALT  
 绕过认证,直接访问任意工单  
  
- • **RCE 升级**  
:结合 CVE-2024-2961  
(CNEXT)漏洞,通过读取 /proc/self/maps  
 和 libc.so.6  
 实现代码执行,写入 Web Shell  
  
### 修复建议  
- • 立即升级至 osTicket 1.18.3/1.17.7  
 或更高版本  
  
- • 修复补丁通过禁用 PHP 流包装器阻止漏洞利用  
  
- • Linux 服务器需同时修复 glibc CVE-2024-2961  
  
- • 临时缓解:禁用公开注册、要求登录提交工单、禁用 HTML 内容  
  
**检测指标**  
:大量 /login.php  
 请求、异常的 PDF 打印请求、包含 php%3a//  
 和 convert.iconv  
 的长 URL、Web 根目录出现可疑 PHP 文件。  
# 从工单到Shell:利用PHP过滤器和CNEXT攻击osTicket(CVE-2026-22200)  
  
![](https://mmbiz.qpic.cn/mmbiz_png/MuPQsYZPics7W1hIpSh8qfyAJV1gLfRB7szNBMnVjibEOlgCPsZj3DcBj5HsNsLo6BDt0u2dz5k8Vw9rpBNYuv2Q/640?wx_fmt=png&from=appmsg "null")  
  
## 背景介绍  
  
![](https://mmbiz.qpic.cn/mmbiz_png/MuPQsYZPics7W1hIpSh8qfyAJV1gLfRB7vwxkX4ficWIibcZbUBJOz6ic5khkRSC6XnVBuFoEI3cia8ZhLme17iblQ5w/640?wx_fmt=png&from=appmsg "null")  
  
  
osTicket是一个广泛使用的开源工单系统,深受需要轻量级自托管支持解决方案的组织青睐。在Horizon3.ai的工作中,我们经常在SLED(州、地方和教育)部门以及其他中型到中小型企业中遇到它。数千个实例暴露在互联网上,更多部署在内部网络中,攻击面相当可观。  
  
工单系统往往是攻击者的高价值目标。这些系统通常包含令牌或凭据等敏感信息,可能成为渗透内部网络的突破口。近期在野外被利用的工单系统漏洞包括影响Solarwinds Web Help Desk的CVE-2024-28986/CVE-2024-28987  
以及影响SysAid的CVE-2025-2775/CVE-2025-2776  
。  
  
从架构上看,osTicket是一个老派的PHP应用程序。它最初发布于2003年,已被广泛研究,包括   
SonarSource[1]  
、  
Checkmarx[2]  
 以及  
其他研究者[3]  
的工作。尽管经过了大量审查,但在我们审视代码库时,应用程序对旧版第三方库的依赖引起了我们的注意,这值得深入探索。考虑到PHP过滤器链利用的最新进展,我们看到了应用新视角的机会。  
## 漏洞分析  
### 从Sink开始:mPDF  
  
我们首先分析了   
mPDF[4]  
,这是osTicket用于从支持工单生成PDF文档的第三方PHP库。任何被授权查看工单的用户都可以访问此功能,包括未经身份验证的访客(如果工单系统配置为允许访客访问,这是默认设置)。  
  
PDF库通常非常复杂,因为它们必须在两种复杂格式(HTML/CSS和PDF)之间架起桥梁。将这些库集成到应用程序中的一个反复出现的失败点是处理外部资源。通常不清楚调用应用程序在将URL或本地文件路径传递给PDF生成器之前必须进行何种程度的清理,而生成器本身也可能存在漏洞。这可能导致SSRF或本地文件读取漏洞。  
  
在研究mPDF时,我们偶然发现了一个有趣的相关CTF挑战   
web2pdf[5]  
,由   
@_splitline_[6]  
 在HITCON CTF 2022上提出,该挑战探讨了如何使用mPDF通过简单的HTML片段读取任意本地文件:  
```
<img src="<malicious_url>"/>
```  
  
解决该挑战涉及两个技巧:  
- • **规范化绕过:**  
 mPDF试图将危险的URI方案(如phar://  
和php://  
)列入黑名单。然而,库的路径处理中的一个漏洞允许攻击者使用修改后的路径(如php:\\  
或./php://  
)绕过此检查。mPDF在规范化URL之前对其进行流包装器黑名单检查。这个漏洞在最新版本的mPDF中仍然存在!  
  
- • **PHP过滤器魔法:**  
 为了绕过mPDF的图像验证,使用PHP过滤器链在任意文件内容前添加有效的位图(BMP)头。这欺骗mPDF将任意文件(例如/etc/passwd  
)作为有效图像渲染到PDF中。然后可以从PDF文件中的结果位图提取敏感数据。  
  
BMP技巧特别方便,因为它允许一次性高效地窃取文件,而无需使用较慢的  
基于错误的oracle[7]  
方法。  
### 障碍1:不同版本的mPDF  
  
在将CTF解决方案应用于osTicket时,我们遇到的第一个障碍是osTicket使用的是2019年左右的非常旧的mPDF版本。web2pdf挑战中的规范化绕过在osTicket嵌入的mPDF版本中根本不存在。  
  
然而,我们发现了另一个涉及URL编码的规范化绕过。像php%3a//  
这样的URL编码流包装器可以绕过黑名单流包装器检查。这是由于旧版本mPDF中的逻辑在检查本地资源是否在流包装器黑名单中之后,但在访问它们之前  
对本地资源进行URL解码[8]  
。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/MuPQsYZPics7W1hIpSh8qfyAJV1gLfRB7ng1fria8vv6H66Hz0F1L99I0qFD4icuOPEQp4iaNQYnicvsovPpJ75OBoQ/640?wx_fmt=png&from=appmsg "null")  
  
  
这些解码后的资源随后使用file_get_contents  
访问:  
  
![](https://mmbiz.qpic.cn/mmbiz_png/MuPQsYZPics7W1hIpSh8qfyAJV1gLfRB72cfI9UF8d09vmMx7CiaQUVLHrpiauGu2umhuNn3lLsWrw3Wzqib2MW8Vg/640?wx_fmt=png&from=appmsg "null")  
  
### 障碍2:HTML清理  
  
即使绕过了mPDF,我们仍然必须通过osTicket的输入验证层传递payload。工单中的所有富文本HTML内容都会被清理,然后由   
htmLawed[9]  
 处理,这是一个用于通过中和可疑标签和属性来净化输入的第三方库。  
  
htmLawed使用基于白名单的方法严格检查URI方案,并且足够智能,可以识别像%3a  
这样的URL编码冒号。像这样的输入URI:  
```
<img src="php%3a//myurl">
```  
  
会被添加denied:  
前缀进行中和:  
  
![](https://mmbiz.qpic.cn/mmbiz_png/MuPQsYZPics7W1hIpSh8qfyAJV1gLfRB7LzKCiau1VAA8anEltc1bNEO71H6zFglLThlWnN1D9yPYfnrxrkDQUTg/640?wx_fmt=png&from=appmsg "null")  
  
  
我们在其他图像属性(如srcset  
)中遇到了同样的问题。style  
属性中的所有URI也被完全阻止。例如,像这样的style  
属性:  
```
<ul><li style="list-style-image:url(http://myurl.com)">listitem</li></ul>
```  
  
也会被添加denied:  
前缀进行中和:  
  
![](https://mmbiz.qpic.cn/mmbiz_png/MuPQsYZPics7W1hIpSh8qfyAJV1gLfRB7YLR1x1Cy14XlLtYmpqeZmBGb4mV9hnjYyTp1PG6kn0TPwdibVpcJp7A/640?wx_fmt=png&from=appmsg "null")  
  
### 绕过HTML清理  
  
在测试style  
属性时,我们注意到htmLawed中存在一个微妙的解析差异。如果我们在url  
关键字和左括号之间加入空格,URI就能逃脱清理器的白名单检查。  
  
例如,这个payload完全通过了htmLawed:<ul><li style="list-style-image:url (http://myurl.com)">listitem</li></ul>  
  
![](https://mmbiz.qpic.cn/mmbiz_png/MuPQsYZPics7W1hIpSh8qfyAJV1gLfRB7UpAevkc1zOp8bgU06aUk6fvynIkCqOmkGqonBAHEAiaSFtgTib5Dclow/640?wx_fmt=png&from=appmsg "null")  
  
  
然而,这并不是立即成功。mPDF遵循严格的CSS标准,期望url()  
没有额外的空格。如果我们保留空格,利用在sink处失败;如果我们去掉它,htmLawed会阻止URI。  
  
但在这次测试中,我们还注意到输出被奇怪地破坏了。  
```
<ul><li style="list-style-image:url (http">listitem</li></ul>
```  
  
我们发现osTicket在htmLawed中  
注册了一个自定义的清理后回调[10]__html_cleanup  
,对style  
属性执行额外的字符串操作。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/MuPQsYZPics7W1hIpSh8qfyAJV1gLfRB7UJSTdtXJo2J8tx8TgLSL8icjkG4lOkAAAwM8BaEPqFySHXjdicalyVyg/640?wx_fmt=png&from=appmsg "null")  
  
  
这段代码很危险,因为它在已经从htmLawed清理过的输出上进行处理。这段代码中发生了多个转换,包括最重要的HTML实体解码和字符剥离。我们现在的挑战是想出一个能够通过htmLawed、通过__html_cleanup  
中关键字符(引号、分号、冒号等)处理,并转换为mPDF接受的内容的payload。我们想出了这个payload:  
```
<ul><li style="list-style-image:url&#34(php%3a//myurl)">listitem</li></ul>
```  
  
这使用HTML实体&#34  
表示"  
来绕过htmLawed。然后这个实体在__html_cleanup  
中被解码和剥离。注意实体不需要尾随分号!实际上,使用&#34;  
会破坏__html_cleanup  
中的解析逻辑。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/MuPQsYZPics7W1hIpSh8qfyAJV1gLfRB7eMhiakwCiaGI5PqE7TM1B179X4Nibyphw5xyqUk1elG7yliaIu2gfyD6pQ/640?wx_fmt=png&from=appmsg "null")  
  
  
这是payload从源到sink的流程:  
1. 1. **恶意输入:**url&#34(php%3a//myurl)  
  
1. 2. **htmLawed输出(未修改):**url&#34(php%3a//myurl)  
  
1. 3. **__html_cleanup中的实体解码:**url"(php%3a//myurl)  
  
1. 4. **__html_cleanup中的字符剥离:**url(php%3a//myurl)  
  
1. 5. **mPDF中的URL解码:**url(php://myurl)  
  
## 完整利用:PDF文件读取攻击  
  
现在我们有了一个可用的payload,让我们演示端到端的利用流程。我们假设在Ubuntu上运行默认配置的osTicket 1.18.2版本,并设置了电子邮件。所有引用的脚本都在 https://github.com/horizon3ai/CVE-2026-22200。  
### 获取工单访问权限  
  
要触发PDF导出,攻击者必须首先能够查看提交的工单。在默认的osTicket配置中,匿名攻击者有两条路径:  
- • **自助注册:**  
 如果启用(默认),攻击者可以简单地注册账户、登录并打开工单。  
  
- • **暴力破解:**  
 如果禁用自助注册,攻击者可以以访客身份提交工单,然后通过"检查工单状态"表单暴力破解访问权限  
  
暴力破解路径得益于以下因素:  
- • **检查工单状态Oracle**  
: 检查工单状态表单充当oracle,当电子邮件地址和工单号的组合有效时会确认。如果有效,会向用户的电子邮件发送工单访问链接。  
  
- • **小工单号空间**  
: 默认情况下,工单号空间限制为6位数字,从100000开始到999999结束  
  
- • **速率限制绕过:**  
 可以通过在每个请求之前简单地打开新会话来绕过每用户速率限制保护。这也规避了暴力破解尝试的日志记录。  
  
- • **多个工单**  
: 攻击者可以打开多个工单(例如100个),使暴力破解显著加快,因为工单号在6位数空间中随机分布。  
  
在我们的测试中,通过标准互联网连接在不到一小时内就能轻松完成暴力破解。  
```
% python osticket_access_bruteforce.py http://osticket.example.com 'XXX@XXX.com' --threads 20======================================================================osTicket工单访问链接枚举脚本======================================================================目标:        http://osticket.example.com/邮箱:         XXX@XXX.com工单范围:  100000 - 999999延迟:         0.5秒线程:       20[*] 扫描开始于: 2026-01-21 14:47:16[i] 进度: 100/900000 已测试, 0 个有效[i] 进度: 200/900000 已测试, 0 个有效[i] 进度: 300/900000 已测试, 0 个有效>>截断<<[i] 进度: 27000/900000 已测试, 0 个有效[i] 进度: 27100/900000 已测试, 0 个有效[i] 进度: 27200/900000 已测试, 0 个有效[+] 有效: 工单 #127227 - 访问链接已发送(需要邮箱验证)[i] 进度: 27300/900000 已测试, 1 个有效[i] 进度: 27400/900000 已测试, 1 个有效[i] 进度: 27500/900000 已测试, 1 个有效>>截断<<
```  
  
某些非默认但相对常见的设置使工单访问更加容易:  
- • **自动回复器**  
: 如果启用了"新工单:工单所有者"  
自动回复器,系统会立即向提交新工单的任何人发送工单访问链接。  
  
- • **UI自定义**  
: 如果修改了工单提交模板以直接显示工单号,则根本不需要暴力破解。  
  
### 向工单注入Payload  
  
获得工单访问权限后,攻击者现在可以注入针对服务器上特定文件的payload。在下面的示例中,我们生成了一个payload来窃取/etc/passwd  
和敏感的include/ost-config.php  
文件。这个恶意字符串直接放入工单的富文本HTML内容中。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/MuPQsYZPics7W1hIpSh8qfyAJV1gLfRB7JgAdNxB4YyMtNsYAxQpqLmuebe9l3NGTzbibia9maicWlc3tKlHZwWeSA/640?wx_fmt=png&from=appmsg "null")  
  
#### 处理工单回复  
  
如果攻击者想在工单已经打开后针对其他文件,他们可以通过回复工单注入更多payload。然而,系统处理工单回复的方式与工单打开略有不同:它执行两次HTML实体解码而不是一次。  
  
为了解决这个问题,payload必须再次编码。payload不是使用&#34  
,而是需要嵌套实体序列&#38;&#35;&#51;&#52  
才能在双重解码过程中存活并以正确格式到达mPDF sink。我们的osticket_ticket_payload_gen  
脚本使用--reply  
标志处理这个问题。  
### PDF提取  
  
一旦工单包含恶意HTML,攻击者导航到工单视图并将其"打印"为PDF。这迫使mPDF处理注入的list-style-image  
属性,解析PHP过滤器链并渲染目标文件。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/MuPQsYZPics7W1hIpSh8qfyAJV1gLfRB7Ria0WpuptBFqvKLDAQAw9cicWv7bcm8A9uuAQ0LNcATNYHPM05dRPI5g/640?wx_fmt=png&from=appmsg "null")  
  
  
窃取的数据作为位图图像嵌入生成的PDF中。这些文件可以通过从PDF的图像对象中剥离伪造的BMP头来提取。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/MuPQsYZPics7W1hIpSh8qfyAJV1gLfRB78f2udTJDKru0tRMmvtFQQDm89qzvTZV93b51tbW2L8MBe5n9oia8VsA/640?wx_fmt=png&from=appmsg "null")  
  
### 文件读取注意事项  
  
在测试过程中,我们发现了几个影响窃取可靠性的细微差别:  
- • **大写字符敏感性:**  
 我们观察到包含大写字符的文件路径有时会导致窃取失败。我们的osticket_ticket_payload_gen  
脚本通过在payload中对大写字母进行URL编码来解决这个问题。  
  
- • **编码变化:**  
 虽然标准过滤器链适用于文本,但二进制文件可能很挑剔。我们发现在BMP转换之前将数据包装在**Base64**  
或**zlib+Base64**  
过滤器中可以为二进制文件产生稳定的结果。我们的osticket_ticket_payload_gen  
脚本提供了这些编码选项。  
  
- • **大小限制:**  
 窃取的图像通常似乎在约45KB处被截断。虽然这足以捕获配置文件和凭据,但可能限制二进制文件、数据库文件和大型日志文件的窃取。  
  
## 任意文件读取的影响  
  
攻击者可以利用osTicket中的任意文件读取做什么?除了标准系统文件(如/etc/passwd  
)之外,主要目标是位于应用程序Web根目录中include/ost-config.php  
的配置文件。  
```
# 加密/解密密钥 - 安装期间随机生成define('SECRET_SALT','SEFDaIg1UP=Rh0xHE=Ij6Lew8u49L=Tt');# 默认管理员邮箱。仅用于数据库连接问题和相关警报define('ADMIN_EMAIL','XXX@XXX.com');# 数据库选项# ====================================================# Mysql登录信息#define('DBTYPE','mysql');# DBHOST可以有逗号分隔的主机(例如 db1:6033,db2:6033)define('DBHOST','localhost');define('DBNAME','osticket');define('DBUSER','osticket');define('DBPASS','XXXXXXXX');
```  
  
此文件包含osTicket数据库的凭据和用于加密操作的SECRET_SALT  
值。如果数据库恰好暴露在外部,攻击者可以访问它并转储所有工单数据。此外,数据库密码本身也是针对其他组织账户进行凭据填充的候选对象。  
  
SECRET_SALT  
是一个主密钥,用于加密/解密数据库中的敏感配置,如LDAP凭据、SMTP凭据和AWS访问密钥。请注意,即使数据库未暴露在外部,在1.18.2之前的osTicket版本中,存在一个重大的SQL注入漏洞   
CVE-2025-26241[11]  
,使任何经过身份验证的用户(包括自助注册用户)都能转储osTicket数据库的内容。当与此漏洞CVE-2026-22200配对时,它提供了对SECRET_SALT  
的访问,攻击者可以完全读取数据库的内容。  
  
SECRET_SALT  
还用于生成工单访问链接(下文将进一步描述)。  
  
在Windows安装上,影响可能进一步扩大;很可能可以访问加入域的计算机上远程SMB共享上的文件,并通过强制身份验证尝试泄露运行osTicket的服务账户的NTLM哈希。  
### 伪造工单访问  
  
SECRET_SALT  
值还允许攻击者绕过身份验证以获得对工单的访问权限。  
  
osTicket默认允许访客用户使用访问链接直接访问工单而无需登录。生成此访问链接有两种方法 - 我们将演示较旧但仍然有效的已弃用方法,该方法更容易伪造。  
  
已弃用的访问链接由四个组件构建:  
- • 内部工单id(自动递增标识符)  
  
- • 外部工单号(默认6个数字)  
  
- • 用户电子邮件  
  
- • SECRET_SALT  
值  
  
除了SECRET_SALT  
值之外,工单访问链接的其他组件可以在不触发任何速率限制的情况下被暴力破解。  
  
如果启用了用户自助注册(默认),用户注册端点充当oracle,将泄露用户电子邮件是否已被注册,从而允许用户名枚举。osticket_registered_user_enum.py  
脚本演示了如何做到这一点。  
  
如上所述,可以使用检查工单访问oracle和osticket_access_bruteforce.py  
脚本高效地暴力破解用户及其关联的外部工单号。  
  
内部工单id是从1开始的自动递增标识符。综合起来,攻击者可以按如下方式伪造访问链接:  
```
% python3 osticket_forge_access_link.py 637963 140 'XXX@XXX.com' 'SEFDaIg1UP=Rh0xHE=Ij6Lew8u49L=Tt' http://osticket.example.com[*] 为ID计算哈希: 140, 邮箱: XXX@XXX.com...[*] 计算的哈希 (a): a32056617064315cae1b4d98a8c95772[*] 发送GET请求到: http://osticket.example.com/view.php[*] 请求参数: {'t': '637963', 'e': 'XXX@XXX.com', 'a': 'a32056617064315cae1b4d98a8c95772'}[+] 请求成功发送。分析响应...--------------------------------------------------发送的完整URL: http://osticket.example.com/tickets.php?id=140状态码: 200
```  
## 通过CNEXT将文件读取链接到RCE  
  
2024年,  
@cfreal_[12]  
 在glibc  
的iconv()  
函数中发现了  
一个精彩的基于堆的缓冲区溢出漏洞[13]  
,CVE-2024-2961(CNEXT)。我们不会在这里详细介绍,但漏洞的要点是任何PHP文件读取原语都可以转换为RCE。据报道,这在2024年在野外被利用,与影响Adobe Magento的未经身份验证的XXE漏洞   
CVE-2024-34102[14]  
 结合使用。同样的RCE链可以与CVE-2026-22200一起使用,我们将在下面演示。  
  
原始利用[15]  
在高层次上需要了解PHP进程内存布局(可以从/proc/self/maps  
文件获得)和来自目标的整个libc.so.6  
二进制文件以准确计算偏移量。然而,如"文件读取注意事项"部分所述,osTicket PDF生成器将窃取限制为每个"图像"约45KB。因此我们修改了利用以适应osTicket。  
  
首先,我们使用文件读取原语读取目标上的/proc/self/maps  
和部分libc.so.6  
文件,使用zlib+base64编码。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/MuPQsYZPics7W1hIpSh8qfyAJV1gLfRB7wvM8llU2UFgmnAJuoVIhOODYLSyRGRTPILqXeYS0guficAFd9mCRV3g/640?wx_fmt=png&from=appmsg "null")  
  
  
在将payload作为回复添加到现有工单后,我们将工单打印为PDF并提取文件。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/MuPQsYZPics7W1hIpSh8qfyAJV1gLfRB7j8Xd9XyRZcYeH6nQ3wicbu3M3NvOdoJQHVk4oicUcialt3wmrVHGibD0gQ/640?wx_fmt=png&from=appmsg "null")  
  
  
接下来,我们使用NT_GNU_BUILD_ID  
对部分libc库进行指纹识别,并使用pwntools  
库从 https://libc.rip/ 下载完整的libc  
。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/MuPQsYZPics7W1hIpSh8qfyAJV1gLfRB7WBy67Gn1nyzbMOIuhrZfMH8Db59Jk0EsQDwhK6Gv0EHDpOUKCE3gnA/640?wx_fmt=png&from=appmsg "null")  
  
  
然后,使用完整的libc  
和/proc/self/maps  
文件,我们生成一个CNEXT payload,将Web shell写入应用程序Web根目录。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/MuPQsYZPics7W1hIpSh8qfyAJV1gLfRB7JoaWmtnpvuIm7PTUH9DWgYJKwEMK6UScqa9Mg4v1yucxH8gcgOibvIw/640?wx_fmt=png&from=appmsg "null")  
  
  
然后我们将CNEXT payload添加到现有工单并再次导出为PDF以触发利用。这将导致内部服务器错误并重置连接,但Web shell将可用,应用程序将继续正常运行。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/MuPQsYZPics7W1hIpSh8qfyAJV1gLfRB7hLpTTJNjbicIzKy2ibnPkFGJqvgN30eqQlSUnsN2iblyr2P6Shiazh7aOQ/640?wx_fmt=png&from=appmsg "null")  
  
## Claude也能轻松搞定  
  
端到端的利用序列自动化起来有点复杂,虽然我们可以手写一个一键利用脚本,但我们很好奇Claude Code with Opus 4.5是否能自己将不同的步骤拼接在一起。我们针对运行在默认配置下的osTicket设置了一个CTF,在根目录中设置了一个随机生成的flag文件。我们给Claude一个提示,描述了漏洞和本博客文章中概述的步骤。我们指示Claude只有在需要访问电子邮件时才寻求帮助。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/MuPQsYZPics7W1hIpSh8qfyAJV1gLfRB7IXkgmW7cM1libE5aicjiaMuechgGut8MnGYLSBHWBd0CHsibI9Dc88ibsAw/640?wx_fmt=png&from=appmsg "null")  
  
  
在10分钟内,Claude就能搞定,只在注册账户后获取确认邮件内容时请求了一次帮助。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/MuPQsYZPics7W1hIpSh8qfyAJV1gLfRB7szNBMnVjibEOlgCPsZj3DcBj5HsNsLo6BDt0u2dz5k8Vw9rpBNYuv2Q/640?wx_fmt=png&from=appmsg "null")  
  
## 修复建议  
  
如果您正在运行面向互联网的osTicket实例,应立即修补到  
最新的osTicket版本1.18.3 / 1.17.7[16]  
或更高版本。  
补丁[17]  
通过在调用mPDF之前禁用PHP流包装器来解决CVE-2026-22200。如果您在Linux服务器上运行osTicket,我们还建议检查并修补服务器的CVE-2024-2961,该漏洞影响glibc  
版本<= 2.39。  
  
如果无法修补,以下缓解措施可以帮助防止匿名攻击者的利用:  
- • 实施网络或主机防火墙规则以限制对osTicket服务器的访问  
  
- • 在管理面板 -> 用户  
选项卡中更新osTicket配置以禁用公共用户自助注册  
  
- • 在管理面板 -> 用户  
选项卡中更新osTicket配置以要求注册和登录才能提交工单  
  
- • 在管理面板 -> 系统  
选项卡中更新osTicket配置以禁用线程条目和电子邮件通信中的HTML  
  
## 漏洞检测  
  
我们提供了一个检查脚本check.py  
,可用于确定您是否运行过时的osTicket版本。这不会直接测试利用,而是检查1.18.3 / 1.17.7更新中的其他更改。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/MuPQsYZPics7W1hIpSh8qfyAJV1gLfRB7l9TicWmMdrfeRJwveKIyMd9r7xZrqnNoODiaz5tGlW3cNwVMc3HwIyYg/640?wx_fmt=png&from=appmsg "null")  
  
## 入侵指标(IoCs)  
  
以下指标是潜在入侵的证据:  
- • Web服务器访问日志包含大量对/login.php  
端点的GET  
和POST  
请求,表明暴力破解尝试访问工单,可能伴随可疑的用户代理如python-requests  
  
- • 创建的工单或注册账户的用户数量高于正常水平  
  
- • Web服务器访问日志条目包含大量将工单打印为PDF的GET请求,例如GET /tickets.php?a=print&id=140  
  
- • Web服务器访问日志条目包含带有长路径的GET请求,包含PHP过滤器payload,包含诸如php%3a//  
和convert.iconv  
等字符串,通常导致414 Request-URI Too Large错误  
  
- • osTicket应用程序Web根目录中存在Web shell PHP脚本  
  
## 时间线  
- • **2025年8月28日**  
: Horizon3.ai通过电子邮件向EnhanceSoft报告PDF文件读取问题,并声明90天披露政策  
  
- • **2025年8月29日**  
: EnhanceSoft确认报告  
  
- • **2025年9月3日**  
: Horizon3.ai报告PDF文件读取问题可以在与CNEXT利用时导致RCE。Horizon3.ai披露其他中/低严重性问题(存储型XSS、SSRF等)  
  
- • **2025年9月4日**  
: EnhanceSoft确认额外信息  
  
- • **2025年9月至12月**  
: Horizon3.ai和EnhanceSoft之间就补丁状态进行多次跟进  
  
- • **2025年1月12日**  
: 在向供应商初次披露130多天后,Horizon3.ai公开披露CVE-2026-22200并通知EnhanceSoft公开披露  
  
- • **2025年1月12日至1月15日**  
: EnhanceSoft确认漏洞并与Horizon3.ai合作验证修复  
  
- • **2025年1月15日**  
: EnhanceSoft发布修补版本1.18.3 / 1.17.7  
  
- • **2025年1月22日:**  
 本博客文章发布  
  
## 参考资料  
- • https://osticket.com/osticket-v1-18-3-v1-17-7-available/  
  
- • https://github.com/horizon3ai/CVE-2026-22200  
  
- • https://blog.splitline.tw/hitcon-ctf-2022/#%F0%9F%93%83-web2pdf-web  
  
- • https://blog.lexfo.fr/iconv-cve-2024-2961-p1.html  
  
- • https://github.com/ambionics/cnext-exploits/blob/main/cnext-exploit.py  
  
- • https://nvd.nist.gov/vuln/detail/cve-2026-22200  
  
- • https://nvd.nist.gov/vuln/detail/cve-2024-2961  
  
- • https://www.cve.org/CVERecord?id=CVE-2025-26241  
  
> 原文:https://horizon3.ai/attack-research/attack-blogs/ticket-to-shell-exploiting-php-filters-and-cnext-in-osticket-cve-2026-22200/  
  
> 仓库: https://github.com/horizon3ai/CVE-2026-22200  
  
#### 引用链接  
  
[1]  
 SonarSource: https://www.sonarsource.com/blog/pitfalls-of-desanitization-leaking-customer-data-from-osticket/  
[2]  
 Checkmarx: https://checkmarx.com/blog/securing-open-source-solutions-a-study-of-osticket-vulnerabilities/  
[3]  
 其他研究者: https://members.backbox.org/osticket-sql-injection/  
[4]  
 mPDF: https://github.com/mpdf/mpdf  
[5]  
 web2pdf: https://blog.splitline.tw/hitcon-ctf-2022/#%F0%9F%93%83-web2pdf-web  
[6]  
 @\_splitline\_: https://x.com/_splitline_  
[7]  
 基于错误的oracle: https://www.synacktiv.com/publications/php-filter-chains-file-read-from-error-based-oracle  
[8]  
 对本地资源进行URL解码: https://github.com/osTicket/osTicket/blob/v1.18.2/include/mpdf/vendor/mpdf/mpdf/src/Image/ImageProcessor.php#L184  
[9]  
 htmLawed: https://www.bioinformatics.org/phplabware/internal_utilities/htmLawed/  
[10]  
 注册了一个自定义的清理后回调: https://github.com/osTicket/osTicket/blob/v1.18.2/include/class.format.php#L249  
[11]  
 CVE-2025-26241: https://www.cve.org/CVERecord?id=CVE-2025-26241  
[12]  
 @cfreal\_: https://x.com/cfreal_  
[13]  
 一个精彩的基于堆的缓冲区溢出漏洞: https://blog.lexfo.fr/iconv-cve-2024-2961-p1.html  
[14]  
 CVE-2024-34102: https://nvd.nist.gov/vuln/detail/cve-2024-34102  
[15]  
 原始利用: https://github.com/ambionics/cnext-exploits/blob/main/cnext-exploit.py  
[16]  
 最新的osTicket版本1.18.3 / 1.17.7: https://osticket.com/osticket-v1-18-3-v1-17-7-available/  
[17]  
 补丁: https://github.com/osTicket/osTicket/commit/c59b067dbfaa08c0f8a9cafa0674e4c93063a742#diff-fa76294350f36fee9fdd2c8c548c016fe7f403edcf81068bde5f51319dd5b8b4R50  
  
  
   
  
  
