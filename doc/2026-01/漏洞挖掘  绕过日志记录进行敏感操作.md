#  漏洞挖掘 | 绕过日志记录进行敏感操作  
原创 进击的HACK
                    进击的HACK  进击的HACK   2026-01-27 23:50  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/DuibU3GqmxVmRsdItbBVRKegNHicHQvAHDdZsGpLVU7touSU1AU1twHTfRjG3Vu5aUh0RnPPllfVUhs4qdWF5QYQ/640?wx_fmt=png&wxfrom=13 "")  
  
声明：  
文中所涉及的技术、思路和工具仅供以安全为目的的学习交流使用，任何人不得将其用于非法用途给予盈利等目的，否则后果自行承担！  
  
如有侵权烦请告知，我会立即删除并致歉。谢谢  
！  
  
文章有疑问的，可以公众号发消息问我，或者留言。我每天都会看的。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zYJrD2VibHmqgf4y9Bqh9nDynW5fHvgbgkSGAfRboFPuCGjVoC3qMl6wlFucsx3Y3jt4gibQgZ6LxpoozE0Tdow/640?wx_fmt=png&wxfrom=13 "")  
  
  
  
   
  
## 前言  
  
一个网站，为了满足安全合规的要求，通常要存在日志记录功能。一些招标文件上也会要求网站存在相对于的功能。  
  
有了系统日志，有利于后续运维，系统出现问题也方便我们溯源。日志一般要求记录敏感操作，并且不允许清除。  
  
在一次偶然的测试中，我发现一种绕过日志记录操作的办法。  
  
虽然危害不高，但也算是一个漏洞，给师傅们提供思路。  
## 漏洞原理  
**正常日志记录**  
：  
![4d690c47e4ade313b9098e089b5049ec.png](https://mmbiz.qpic.cn/sz_mmbiz_png/a1BOUvqnbriaU6HH8vZknAE7s1dic4nr8j6Sibu3aEotprM66xTuM0eSvicdqlyTVqwv5v0OUKtOWAILLibGCk2DTvA/640?from=appmsg "")  
  
4d690c47e4ade313b9098e089b5049ec.png  
  
漏洞原理非常的简单，要求 web 系统的日志有获取 IP 的功能，其次获取的 IP 可被我们伪造，比如通过如下方式：  
```
X-Forwarded-For: 127.0.0.1
X-Forwarded-Host: 127.0.0.1
X-Real-IP: 127.0.0.1
X-Original-Host: 127.0.0.1
X-Original-IP: 127.0.0.1
Via: 127.0.0.1
X-Via: 127.0.0.1
CF-Connecting-IP: 127.0.0.1
X-Client-IP: 127.0.0.1
X-Cluster-Client-IP: 127.0.0.1
```  
  
如下图，我们发送登录请求后，服务端接收到，并从**X-Forwarded-For**  
中读取 127.0.0.1。  
![f1b14da3736fc19c38ff143ca6a40297.png](https://mmbiz.qpic.cn/sz_mmbiz_png/a1BOUvqnbriaU6HH8vZknAE7s1dic4nr8jHOCzjLv3eGppOicB04bNxfceOPunwfEfiaXC0sIgEJfRFGQ2Ly4tl3ZA/640?from=appmsg "")  
  
f1b14da3736fc19c38ff143ca6a40297.png  
  
此时就有了伪造 IP 的漏洞，但这并不能隐藏我们对网站进行的操作。  
  
网站获取请求包的 IP 地址，如果未对 IP 进行严格校验，仅仅接受一个字符串，就会出现  
```
X-Forwarded-For: your log is wrong
```  
  
![12fe1b69171831c75c9d61d81ec34fd6.png](https://mmbiz.qpic.cn/sz_mmbiz_png/a1BOUvqnbriaU6HH8vZknAE7s1dic4nr8jSgtPGTENP40HxkRiakN05NMcfTZWiaIsx0yd9rm5chkwrzbI31R29HcQ/640?from=appmsg "")  
  
12fe1b69171831c75c9d61d81ec34fd6.png  
  
一般这个字符串会进行限制，长度以 20 为例。  
  
我们输入的字符串长度超过 20，就可以导致代码中的日志记录报错。  
  
一般来说，网站为了不影响系统性能，会用多线程的形式记录日志。**记录日志的线程因为报错终止，而正常操作的线程正常返回响应包**  
。  
**错误日志记录**  
：  
![cdff21fe18aa9cefbcbce86513e01ea0.png](https://mmbiz.qpic.cn/sz_mmbiz_png/a1BOUvqnbriaU6HH8vZknAE7s1dic4nr8jt2CtO7Vdia4mvWgGMRBnffpw7YYmLoMjzZ6u0AZWf1RDY079dxZVu4g/640?from=appmsg "")  
  
cdff21fe18aa9cefbcbce86513e01ea0.png  
  
这样，我们就能在对网站进行敏感操作，比如创建用户、给用户授予管理员权限，但不会出现在系统的日志中。  
## 加固建议  
  
当日志记录有一个字段报错时，给它一个默认值，而不是终止记录。  
  
这样不至于出现系统一团糟，还不知道别人做了什么的情况。  
## 总结  
  
其实不单单是 IP、有的日志会记录 User-Agent，这也是一个测试点。  
  
关键在于，系统代码中将操作信息保存到数据库的过程中的错误处理是否规范，是否考虑全面。  
  
   
  
  
  
欢迎加入知识星球，星球内容主要有：  
  
1、公众号文章备份、工具分享。  
  
2、常见问题的答疑、解决方案汇总在知识星球，作为便于搜索的知识库。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/a1BOUvqnbriaU6HH8vZknAE7s1dic4nr8jmbicTITibLRpH0Y2j4k3RNkj9nETlq3wibeOHZUBNaC3jEfcWdxy7Rib9g/640?wx_fmt=png&from=appmsg "")  
  
  
  
