#  智能工业网关：私有协议解析中的栈溢出漏洞深度剖析  
原创 网络安全实验室  GTG网络安全实验室   2026-01-14 07:00  
  
![](https://mmbiz.qpic.cn/mmbiz_gif/nU5v4aGBAyTCxIBHVZGhicPLY9XcpAMrBiapdMQeia2uOZx3b22q6jHxIfAUGyD1BKREmCdHUlxgZ0dfRy84oQvZQ/640?wx_fmt=gif&from=appmsg "")  
  
。  
  
1  
  
****  
实验背景  
  
  
  
工业网关作为连接 OT（运营技术）与 IT（信息技术）的关键节点，其协议解析的安全性直接关系到工业生产线的安全。本次研究的目标是智能工业网关。通过对该设备核心服务 gateway_service 的逆向分析，我们发现其在处理私有二进制协议时存在严重的栈溢出漏洞。  
  
  
  
2  
  
****  
实验环境  
  
  
  
•目标文件：gateway_service (ELF 32-bit LSB executable, ARM)  
  
•编译选项：已禁用 Stack Canary (-fno-stack-protector)，开启栈执行 (-z execstack)。  
  
•分析工具：IDA Pro  
  
  
使用checksec --file=gateway_service进行分析  
  
  
![](https://mmbiz.qpic.cn/mmbiz_png/nU5v4aGBAyTPZIX2gibZulghgKsYf6zczViaj8HCJYria4yw1ZiciadyWmgtvJ96nKicokgj193Jg6a90WadG8pdRgUQ/640?wx_fmt=png&from=appmsg "")  
  
  
  
  
3  
  
核心漏洞点分析：process packet函数  
  
  
  
定位到process_packet 函数。该函数负责将接收到的原始数据包解析并拷贝到本地缓冲区。  
  
  
  
![](https://mmbiz.qpic.cn/mmbiz_png/nU5v4aGBAyTPZIX2gibZulghgKsYf6zczhiclbKZhm7m489AD8c1cDiapiaYClNds4cR5CHqQbdcEoSy3U3KSzC4hw/640?wx_fmt=png&from=appmsg "")  
  
  
3.1 栈空间布局  
  
在函数入口处，我们可以看到栈空间的分配：  
  
![](https://mmbiz.qpic.cn/mmbiz_png/nU5v4aGBAyTPZIX2gibZulghgKsYf6zczMo2ZPvn8RRicn4hibOnKGGsuW6x9pnKu3AuQ6PpqyaF3nxyWxwVUXZTA/640?wx_fmt=png&from=appmsg "")  
  
局部缓冲区local_buffer  
 位于栈上。  
  
  
3.2 溢出逻辑分析  
  
关键汇编指令：  
  
  
![](https://mmbiz.qpic.cn/mmbiz_png/nU5v4aGBAyTPZIX2gibZulghgKsYf6zczibia9cMNeOWMf9qdTJ6Q3wC60PibRX4L9LSu8pCnGMIEUlnZlUicYVTfNA/640?wx_fmt=png&from=appmsg "")  
  
  
  
问题点总结：  
  
  
1、信任外部输入：  
  
程序直接从数据包中读取 Length 字段（R2），并将其作为 memcpy 的长度参数。  
  
  
2、缺乏边界检查：  
  
在执行 memcpy 之前，程序完全没有检查 Length 是否超过了 local_buffer 的预分配大小（128 字节）。  
  
  
3、栈溢出后果：  
  
如果攻击者构造一个 Length 大于 132 的数据包，memcpy 将会覆盖栈上的返回地址（LR）。当函数执行完毕执行 POP {FP, PC} 时，程序将跳转到攻击者控制的地址。  
  
  
  
4  
  
漏洞利用实战（Exploit）  
  
  
  
为了验证该漏洞，我们编写了一个Python 脚本来自动化构造恶意Payload。  
  
4.1 偏移量计算  
  
  
通过  
 IDA 的栈视图分析：  
  
•local_buffer  
 起始地址：FP - 0x84  
 (132 字节)  
  
•  
函数返回地址：FP + 0x04  
  
•精确偏移量  
 = 132 + 4 = 136  
 字节。  
  
  
4.2 EXP 脚本实现(exploit.py)  
  
  
![](https://mmbiz.qpic.cn/mmbiz_png/nU5v4aGBAyTPZIX2gibZulghgKsYf6zczWhM9Rics4tOfK6wYPumn4OLxPOBLvnxqWA7shOkpUYERJVtw0kFdyuw/640?wx_fmt=png&from=appmsg "")  
  
  
4.3 执行效果  
  
  
当网关服务处理该  
Payload 时，memcpy  
 会将  
 136 字节后的target_pc  
 精确覆盖到栈帧的返回地址处。当函数返回时，程序将跳转执行我们布置在栈上的  
Shellcode，从而获取系统的Shell。  
  
5  
  
安全建议  
  
  
  
1.严格长度校验：  
  
在任何内存拷贝操作前，必须验证长度参数是否在安全范围内。  
  
  
![](https://mmbiz.qpic.cn/mmbiz_png/nU5v4aGBAyTPZIX2gibZulghgKsYf6zczBsCIfUmzQulB6dcPrKU5P0CC9egEVj9YZWMUSoIibCyVVxic9Ukh7MZQ/640?wx_fmt=png&from=appmsg "")  
  
  
  
2.启用现代安全特性：  
  
· Stack Canaries：在栈帧中插入随机值，检测溢出。  
  
· ASLR：地址空间布局随机化，增加劫持执行流的难度。  
  
· NX (No-Execute)：禁止栈空间执行代码。  
  
  
  
  
  
  
  
🔒 安全升级！GTG认证护航物联⽹安全新时代  
  
![](https://mmbiz.qpic.cn/mmbiz_png/nU5v4aGBAySBhpYUWiaeEIQ72iaEOOv1WIFuAPYG7LzgV7AgzynKR6TTrUDy3r3LABn61ZEJfX6WDicgIvqC5Cazw/640?wx_fmt=png&from=appmsg "")  
  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/nU5v4aGBAySBhpYUWiaeEIQ72iaEOOv1WIMomJn5gB7cVvVuuJ1sad2guibjlJAdFNIkicNBicG91avJKosT03KpMrw/640?wx_fmt=jpeg&from=appmsg "")  
  
**GTG网络安全实验室**  
  
🔐 GTG⼴测集团是国内领先的 IoT安全认证专家，尤其擅⻓ EN 18031标准（欧洲物联⽹安全法规）的测试与认证！  
  
  
支持全球网络安全认证检测项目：  
  
![](https://mmbiz.qpic.cn/mmbiz_png/nU5v4aGBAySPA3jzu8ia4icibmF1VXJL8zDGtAa8l6dcaBXj2D1AKMS1s64mtuEpbbhFOLenwRxoa7mEbw1iamJJ7A/640?wx_fmt=png&from=appmsg "")  
  
  
🏆 GTG如何为您的IoT产品保驾护航？  
  
✅ EN 18031合规认证  
：确保您的产品符合欧洲市场准⼊要求  
  
✅ 渗透测试 & 漏洞评估  
：模拟⿊客攻击，提前发现安全隐患  
  
✅ 安全架构设计咨询  
：从底层优化产品安全性能  
  
✅ 全球法规适配  
：协助企业满⾜不同国家的IoT安全标准（如中国GB/T、英国PSTI）  
  
  
💡 为什么选择GTG？  
  
· 国内专业的IoT安全检测机构  
  
· 已经为多家企业提供安全认证服务  
  
· ⾃有攻防实验室，配备专业红队模拟APT攻击场景  
  
  
  
更多相关内容  
  
欢迎关注视频号“  
GTG网络安全实验室”  
  
私信可获取“EN 18031自测工具包”  
  
  
![](https://mmbiz.qpic.cn/mmbiz_gif/nU5v4aGBAyQwHzg2IdmQn0xLicQZHgOSVic0juVMo8aBGpSI4mnUx7h0uhNXtD8pGjwtdiboeDRvs9eowJwkLfM8Q/640?wx_fmt=gif&from=appmsg "")  
  
  
  
  
![](https://mmbiz.qpic.cn/mmbiz_png/nU5v4aGBAyTpqoNYAvbv9qHQ3oxubPJM4A34iaDDhwX7ic1psTuVp2W2rCbwyiash2Ec9tQQiayFV03jxeLtOge6xw/640?wx_fmt=png&from=appmsg "")  
  
****  
